#!/usr/bin/env python3
import pydbus
from pydbus import SessionBus
from gi.repository import GLib
import subprocess
import os
import sys

BUS_NAME = "org.media.mediadebuger6"
OBJECT_PATH = "/org/media/mediadebuger6"
INTERFACE_NAME = "org.media.mediadebuger6"

class MediaDebuger6Service:
    """
    DBus service implementation, wrapping media-debuger6 command
    """
    
    dbus = f"""
    <node>
        <interface name='{INTERFACE_NAME}'>
            <method name='GetBasicInfo'>
                <arg type='s' name='info_type' direction='in'/>
                <arg type='s' name='result' direction='out'/>
            </method>
            <method name='GetMediaInfo'>
                <arg type='s' name='file_path' direction='in'/>
                <arg type='s' name='stream_type' direction='in'/>
                <arg type='s' name='frame_type' direction='in'/>
                <arg type='s' name='result' direction='out'/>
            </method>
            <method name='OpenMediaInfoWindow'>
                <arg type='s' name='file_path' direction='in'/>
                <arg type='s' name='stream_type' direction='in'/>
                <arg type='s' name='frame_type' direction='in'/>
                <arg type='b' name='success' direction='out'/>
            </method>
            <method name='IsAvailable'>
                <arg type='b' name='available' direction='out'/>
            </method>
            <method name='GetVersion'>
                <arg type='s' name='version' direction='out'/>
            </method>
        </interface>
    </node>
    """

    def __init__(self):
        self.bus = SessionBus()
        
    def GetBasicInfo(self, info_type: str) -> str:
        """Get basic information (corresponding to --basic-info)"""
        if not info_type:
            return "Error: info_type cannot be empty"
        
        valid_types = ["version", "buildconf", "formats", "muxers", "demuxers", 
                      "devices", "codecs", "decoders", "encoders", "bsfs", 
                      "protocols", "filters", "pixfmts", "layouts", "samplefmts", 
                      "colors", "license"]
        
        if info_type not in valid_types:
            return f"Error: Invalid info_type. Valid types: {', '.join(valid_types)}"
        
        cmd = ["media-debuger6", "--basic-info", info_type]
        result = self._run_command(cmd)
        print(f"GetBasicInfo({info_type}): {len(result)} characters returned")
        return result

    def GetMediaInfo(self, file_path: str, stream_type: str, frame_type: str) -> str:
        """Get media file information (corresponding to --media-info + --stream-type + --frame-type) - non-blocking version"""
        if not os.path.exists(file_path):
            return f"Error: File not found - {file_path}"
        
        if stream_type not in ["audio", "video", "a", "v"]:
            return "Error: Invalid stream_type (must be audio/video/a/v)"

        if frame_type not in ["frame", "packet", "f", "p"]:
            return "Error: Invalid frame_type (must be frame/packet/f/p)"
        
        cmd = [
            "media-debuger6", "--media-info", file_path,
            "--frame-type", frame_type,
            "--stream-type", stream_type
        ]
        
        result = self._run_command_with_timeout(cmd, timeout=30)
        print(f"GetMediaInfo({file_path}, {stream_type}): {len(result)} characters returned")
        return result

    def OpenMediaInfoWindow(self, file_path: str, stream_type: str, frame_type: str) -> bool:
        """Open media information window, closed manually by user (non-blocking call)"""
        if not os.path.exists(file_path):
            print(f"Error: File not found - {file_path}")
            return False
        
        if stream_type not in ["audio", "video", "a", "v"]:
            print(f"Error: Invalid stream_type (must be audio/video/a/v)")
            return False

        if frame_type not in ["frame", "packet", "f", "p"]:
            print(f"Error: Invalid frame_type (must be frame/packet/f/p)")
            return False
        
        cmd = [
            "media-debuger6", "--media-info", file_path,
            "--frame-type", frame_type,
            "--stream-type", stream_type
        ]
        
        try:
            print(f"Opening media info window: {' '.join(cmd)}")
            
            # Use Popen to start process non-blockingly, without waiting for its completion
            process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True
            )
            
            # Don't wait for process to end, return immediately
            print(f"Media info window opened with PID: {process.pid}")
            print("Window will remain open until user closes it manually")
            return True
            
        except Exception as e:
            print(f"Error opening media info window: {str(e)}")
            return False

    def IsAvailable(self) -> bool:
        """Check if media-debuger6 tool is available"""
        try:
            # First check if the command exists
            result = subprocess.run(
                ["which", "media-debuger6"],
                capture_output=True,
                text=True,
                timeout=5
            )
            
            if result.returncode != 0:
                # If which can't find it, try running directly
                result = subprocess.run(
                    ["media-debuger6", "--version"],
                    capture_output=True,
                    text=True,
                    timeout=5
                )
            
            available = result.returncode == 0
            print(f"IsAvailable(): {available}")
            return available
            
        except (subprocess.SubprocessError, FileNotFoundError, subprocess.TimeoutExpired) as e:
            print(f"IsAvailable() error: {e}")
            return False

    def GetVersion(self) -> str:
        """Get media-debuger6 version information"""
        try:
            result = subprocess.run(
                ["media-debuger6", "--version"],
                capture_output=True,
                text=True,
                timeout=5
            )
            if result.returncode == 0:
                version = result.stdout.strip()
                print(f"GetVersion(): {version}")
                return version
            else:
                error_msg = f"Version command failed with code {result.returncode}"
                print(f"GetVersion(): {error_msg}")
                return error_msg
        except Exception as e:
            error_msg = f"Error getting version: {str(e)}"
            print(f"GetVersion(): {error_msg}")
            return error_msg

    def _run_command(self, cmd: list) -> str:
        """Execute command and return output - for commands that need immediate result return"""
        try:
            print(f"Executing command: {' '.join(cmd)}")
            
            result = subprocess.run(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                timeout=30
            )
            
            output = result.stdout.strip()
            
            if result.returncode != 0:
                error_msg = f"Error (exit code {result.returncode}): {output}"
                print(f"Command failed: {error_msg}")
                return error_msg
            
            print(f"Command succeeded: {len(output)} characters output")
            return output
            
        except subprocess.TimeoutExpired:
            error_msg = "Error: Command timed out after 30 seconds"
            print(error_msg)
            return error_msg
        except Exception as e:
            error_msg = f"Error: {str(e)}"
            print(error_msg)
            return error_msg

    def _run_command_with_timeout(self, cmd: list, timeout: int = 30) -> str:
        """Execute command and return output (with timeout control)"""
        try:
            print(f"Executing command with timeout {timeout}s: {' '.join(cmd)}")
            
            result = subprocess.run(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                timeout=timeout
            )
            
            output = result.stdout.strip()
            
            if result.returncode != 0:
                error_msg = f"Error (exit code {result.returncode}): {output}"
                print(f"Command failed: {error_msg}")
                return error_msg
            
            print(f"Command succeeded: {len(output)} characters output")
            return output
            
        except subprocess.TimeoutExpired:
            error_msg = f"Error: Command timed out after {timeout} seconds"
            print(error_msg)
            return error_msg
        except Exception as e:
            error_msg = f"Error: {str(e)}"
            print(error_msg)
            return error_msg

def register_dbus_service():
    """Register DBus service"""
    try:
        # Get session bus
        bus = SessionBus()
        
        # Create service instance
        service = MediaDebuger6Service()
        
        # Publish service
        bus.publish(BUS_NAME, service)
        
        print(f"DBus service registered successfully:")
        print(f"  Service: {BUS_NAME}")
        print(f"  Object: {OBJECT_PATH}")
        print(f"  Interface: {INTERFACE_NAME}")
        print("Service is running... Press Ctrl+C to stop")
        
        return True
        
    except Exception as e:
        print(f"Failed to register DBus service: {e}")
        return False

def main():
    """Main function"""
    print("Starting Media Debuger6 DBus Service...")
    
    # Check if media-debuger6 is available
    service = MediaDebuger6Service()
    if not service.IsAvailable():
        print("Warning: media-debuger6 command not found. Some functions may not work.")
        print("Please install media-debuger6 or ensure it's in your PATH")
    
    # Register DBus service
    if not register_dbus_service():
        print("Failed to start DBus service. Exiting.")
        sys.exit(1)
    
    # Start event loop
    try:
        loop = GLib.MainLoop()
        print("Service started successfully. Waiting for requests...")
        print("\nAvailable methods:")
        print("  - GetBasicInfo(info_type): Get basic information")
        print("  - GetMediaInfo(file_path, stream_type, frame_type): Get media information (blocking, 30s timeout)")
        print("  - OpenMediaInfoWindow(file_path, stream_type, frame_type): Open media information window (non-blocking, user closes manually)")
        print("  - IsAvailable(): Check if tool is available")
        print("  - GetVersion(): Get version information")
        loop.run()
    except KeyboardInterrupt:
        print("\nService stopped by user")
    except Exception as e:
        print(f"Service error: {e}")
    finally:
        print("Media Debuger6 DBus Service stopped")

if __name__ == "__main__":
    main()