#!/usr/bin/env python3
import pydbus
from pydbus import SessionBus
from gi.repository import GLib
import subprocess
import os
import sys

BUS_NAME = "org.media.mediadebuger"
OBJECT_PATH = "/org/media/mediadebuger"
INTERFACE_NAME = "org.media.mediadebuger"

class MediaDebugerService:
    """
    DBus 服务实现，封装 media-debuger 命令
    """
    
    dbus = f"""
    <node>
        <interface name='{INTERFACE_NAME}'>
            <method name='GetBasicInfo'>
                <arg type='s' name='info_type' direction='in'/>
                <arg type='s' name='result' direction='out'/>
            </method>
            <method name='GetMediaInfo'>
                <arg type='s' name='file_path' direction='in'/>
                <arg type='s' name='stream_type' direction='in'/>
                <arg type='s' name='frame_type' direction='in'/>
                <arg type='s' name='result' direction='out'/>
            </method>
            <method name='OpenMediaInfoWindow'>
                <arg type='s' name='file_path' direction='in'/>
                <arg type='s' name='stream_type' direction='in'/>
                <arg type='s' name='frame_type' direction='in'/>
                <arg type='b' name='success' direction='out'/>
            </method>
            <method name='IsAvailable'>
                <arg type='b' name='available' direction='out'/>
            </method>
            <method name='GetVersion'>
                <arg type='s' name='version' direction='out'/>
            </method>
        </interface>
    </node>
    """

    def __init__(self):
        self.bus = SessionBus()
        
    def GetBasicInfo(self, info_type: str) -> str:
        """获取基本信息（对应 --basic-info）"""
        if not info_type:
            return "Error: info_type cannot be empty"
        
        valid_types = ["version", "buildconf", "formats", "muxers", "demuxers", 
                      "devices", "codecs", "decoders", "encoders", "bsfs", 
                      "protocols", "filters", "pixfmts", "layouts", "samplefmts", 
                      "colors", "license"]
        
        if info_type not in valid_types:
            return f"Error: Invalid info_type. Valid types: {', '.join(valid_types)}"
        
        cmd = ["media-debuger", "--basic-info", info_type]
        result = self._run_command(cmd)
        print(f"GetBasicInfo({info_type}): {len(result)} characters returned")
        return result

    def GetMediaInfo(self, file_path: str, stream_type: str, frame_type: str) -> str:
        """获取媒体文件信息（对应 --media-info + --stream-type + --frame-type）- 非阻塞版本"""
        if not os.path.exists(file_path):
            return f"Error: File not found - {file_path}"
        
        if stream_type not in ["audio", "video", "a", "v"]:
            return "Error: Invalid stream_type (must be audio/video/a/v)"

        if frame_type not in ["frame", "packet", "f", "p"]:
            return "Error: Invalid frame_type (must be frame/packet/f/p)"
        
        cmd = [
            "media-debuger", "--media-info", file_path,
            "--frame-type", frame_type,
            "--stream-type", stream_type
        ]
        
        result = self._run_command_with_timeout(cmd, timeout=30)
        print(f"GetMediaInfo({file_path}, {stream_type}): {len(result)} characters returned")
        return result

    def OpenMediaInfoWindow(self, file_path: str, stream_type: str, frame_type: str) -> bool:
        """打开媒体信息窗口，由用户手动关闭（非阻塞调用）"""
        if not os.path.exists(file_path):
            print(f"Error: File not found - {file_path}")
            return False
        
        if stream_type not in ["audio", "video", "a", "v"]:
            print(f"Error: Invalid stream_type (must be audio/video/a/v)")
            return False

        if frame_type not in ["frame", "packet", "f", "p"]:
            print(f"Error: Invalid frame_type (must be frame/packet/f/p)")
            return False
        
        cmd = [
            "media-debuger", "--media-info", file_path,
            "--frame-type", frame_type,
            "--stream-type", stream_type
        ]
        
        try:
            print(f"Opening media info window: {' '.join(cmd)}")
            
            # 使用 Popen 非阻塞启动进程，不等待其结束
            process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True
            )
            
            # 不等待进程结束，立即返回
            print(f"Media info window opened with PID: {process.pid}")
            print("Window will remain open until user closes it manually")
            return True
            
        except Exception as e:
            print(f"Error opening media info window: {str(e)}")
            return False

    def IsAvailable(self) -> bool:
        """检查 media-debuger 工具是否可用"""
        try:
            # 首先检查命令是否存在
            result = subprocess.run(
                ["which", "media-debuger"],
                capture_output=True,
                text=True,
                timeout=5
            )
            
            if result.returncode != 0:
                # 如果 which 找不到，尝试直接运行
                result = subprocess.run(
                    ["media-debuger", "--version"],
                    capture_output=True,
                    text=True,
                    timeout=5
                )
            
            available = result.returncode == 0
            print(f"IsAvailable(): {available}")
            return available
            
        except (subprocess.SubprocessError, FileNotFoundError, subprocess.TimeoutExpired) as e:
            print(f"IsAvailable() error: {e}")
            return False

    def GetVersion(self) -> str:
        """获取 media-debuger 版本信息"""
        try:
            result = subprocess.run(
                ["media-debuger", "--version"],
                capture_output=True,
                text=True,
                timeout=5
            )
            if result.returncode == 0:
                version = result.stdout.strip()
                print(f"GetVersion(): {version}")
                return version
            else:
                error_msg = f"Version command failed with code {result.returncode}"
                print(f"GetVersion(): {error_msg}")
                return error_msg
        except Exception as e:
            error_msg = f"Error getting version: {str(e)}"
            print(f"GetVersion(): {error_msg}")
            return error_msg

    def _run_command(self, cmd: list) -> str:
        """执行命令并返回输出 - 用于需要立即返回结果的命令"""
        try:
            print(f"Executing command: {' '.join(cmd)}")
            
            result = subprocess.run(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                timeout=30
            )
            
            output = result.stdout.strip()
            
            if result.returncode != 0:
                error_msg = f"Error (exit code {result.returncode}): {output}"
                print(f"Command failed: {error_msg}")
                return error_msg
            
            print(f"Command succeeded: {len(output)} characters output")
            return output
            
        except subprocess.TimeoutExpired:
            error_msg = "Error: Command timed out after 30 seconds"
            print(error_msg)
            return error_msg
        except Exception as e:
            error_msg = f"Error: {str(e)}"
            print(error_msg)
            return error_msg

    def _run_command_with_timeout(self, cmd: list, timeout: int = 30) -> str:
        """执行命令并返回输出（带超时控制）"""
        try:
            print(f"Executing command with timeout {timeout}s: {' '.join(cmd)}")
            
            result = subprocess.run(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                timeout=timeout
            )
            
            output = result.stdout.strip()
            
            if result.returncode != 0:
                error_msg = f"Error (exit code {result.returncode}): {output}"
                print(f"Command failed: {error_msg}")
                return error_msg
            
            print(f"Command succeeded: {len(output)} characters output")
            return output
            
        except subprocess.TimeoutExpired:
            error_msg = f"Error: Command timed out after {timeout} seconds"
            print(error_msg)
            return error_msg
        except Exception as e:
            error_msg = f"Error: {str(e)}"
            print(error_msg)
            return error_msg

def register_dbus_service():
    """注册 DBus 服务"""
    try:
        # 获取会话总线
        bus = SessionBus()
        
        # 创建服务实例
        service = MediaDebugerService()
        
        # 发布服务
        bus.publish(BUS_NAME, service)
        
        print(f"DBus service registered successfully:")
        print(f"  Service: {BUS_NAME}")
        print(f"  Object: {OBJECT_PATH}")
        print(f"  Interface: {INTERFACE_NAME}")
        print("Service is running... Press Ctrl+C to stop")
        
        return True
        
    except Exception as e:
        print(f"Failed to register DBus service: {e}")
        return False

def main():
    """主函数"""
    print("Starting Media Debuger DBus Service...")
    
    # 检查 media-debuger 是否可用
    service = MediaDebugerService()
    if not service.IsAvailable():
        print("Warning: media-debuger command not found. Some functions may not work.")
        print("Please install media-debuger or ensure it's in your PATH")
    
    # 注册 DBus 服务
    if not register_dbus_service():
        print("Failed to start DBus service. Exiting.")
        sys.exit(1)
    
    # 启动事件循环
    try:
        loop = GLib.MainLoop()
        print("Service started successfully. Waiting for requests...")
        print("\nAvailable methods:")
        print("  - GetBasicInfo(info_type): 获取基本信息")
        print("  - GetMediaInfo(file_path, stream_type, frame_type): 获取媒体信息（阻塞，30秒超时）")
        print("  - OpenMediaInfoWindow(file_path, stream_type, frame_type): 打开媒体信息窗口（非阻塞，用户手动关闭）")
        print("  - IsAvailable(): 检查工具是否可用")
        print("  - GetVersion(): 获取版本信息")
        loop.run()
    except KeyboardInterrupt:
        print("\nService stopped by user")
    except Exception as e:
        print(f"Service error: {e}")
    finally:
        print("Media Debuger DBus Service stopped")

if __name__ == "__main__":
    main()
